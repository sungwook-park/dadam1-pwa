<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes,minimum-scale=1.0,maximum-scale=3.0">
  <title>ë‹¤ë‹´ì—…ë¬´ê´€ë¦¬</title>
  <link rel="stylesheet" href="styles/main.css">
  
  <!-- PWA ì§€ì›ì„ ìœ„í•œ ë©”íƒ€ íƒœê·¸ -->
  <meta name="theme-color" content="#219ebc">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ë‹¤ë‹´ì—…ë¬´">
  
  <!-- í„°ì¹˜ ì•„ì´ì½˜ -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“‹</text></svg>">
  
  <!-- í”„ë¦¬ë¡œë“œ ì¤‘ìš” ë¦¬ì†ŒìŠ¤ -->
  <link rel="preload" href="scripts/firebase-config.js" as="script">
  <link rel="preload" href="scripts/auth.js" as="script">
</head>
<body>
  <!-- í—¤ë” ë°” -->
  <div class="header-bar">
    <span class="header-title">
      <span class="header-icon">ğŸ“‹</span>
      ë‹¤ë‹´ì—…ë¬´ê´€ë¦¬
    </span>
    <div class="header-actions">
      <button id="logoutBtn" class="logout-btn" aria-label="ë¡œê·¸ì•„ì›ƒ" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
  
  <!-- í™ˆ ë²„íŠ¼ (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
  <button class="home-btn" onclick="backToHome()" aria-label="í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°" style="display:none;">ğŸ  í™ˆ</button>

  <!-- ë¡œê·¸ì¸ ì˜ì—­ -->
  <div id="login-view">
    <div class="box login-container">
      <h3>ë¡œê·¸ì¸</h3>
      <form id="login-form" onsubmit="return false;" autocomplete="on">
        <input 
          type="email" 
          id="email" 
          placeholder="ì´ë©”ì¼" 
          required 
          aria-label="ì´ë©”ì¼ ì…ë ¥"
          autocomplete="email"
          inputmode="email"
        >
        <input 
          type="password" 
          id="password" 
          placeholder="ë¹„ë°€ë²ˆí˜¸" 
          required 
          aria-label="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
          autocomplete="current-password"
        >
        <button id="loginBtn" type="button" aria-label="ë¡œê·¸ì¸í•˜ê¸°">ë¡œê·¸ì¸</button>
      </form>
      
      <!-- ë¡œë”© ìƒíƒœ í‘œì‹œ -->
      <div id="login-loading" style="display:none; text-align:center; margin-top:15px;">
        <div class="spinner" style="width:30px; height:30px; margin:0 auto 10px;"></div>
        <p style="margin:0; color:#666; font-size:14px;">ë¡œê·¸ì¸ ì¤‘...</p>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì˜ì—­ -->
  <div id="main-view" style="display:none;">
    <!-- ê´€ë¦¬ììš© í™ˆ ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
    <div id="home-buttons" class="button-grid" style="display:none;">
      <button class="menu-button" onclick="openTab('task')" aria-label="ì‘ì—…ì§€ì‹œ ê´€ë¦¬">
        ğŸ“‹<br><span style="margin-top:8px; display:block;">ì‘ì—…ì§€ì‹œ</span>
      </button>
      <button class="menu-button" onclick="openTab('reserve')" aria-label="ì˜ˆì•½ ê´€ë¦¬">
        ğŸ“…<br><span style="margin-top:8px; display:block;">ì˜ˆì•½</span>
      </button>
      <button class="menu-button" onclick="openTab('settle')" aria-label="ì •ì‚° ê´€ë¦¬">
        ğŸ’°<br><span style="margin-top:8px; display:block;">ì •ì‚°</span>
      </button>
      <button class="menu-button" onclick="openTab('spend')" aria-label="ì§€ì¶œ ê´€ë¦¬">
        ğŸ’¸<br><span style="margin-top:8px; display:block;">ì§€ì¶œ</span>
      </button>
      <button class="menu-button" onclick="openTab('inventory')" aria-label="ì…ì¶œê³  ê´€ë¦¬">
        ğŸ“¦<br><span style="margin-top:8px; display:block;">ì…ì¶œê³ </span>
      </button>
      <button class="menu-button" onclick="openTab('holiday')" aria-label="íœ´ë¬´ ê´€ë¦¬">
        ğŸ–ï¸<br><span style="margin-top:8px; display:block;">íœ´ë¬´ê´€ë¦¬</span>
      </button>
    </div>
    
    <!-- íƒ­ ì»¨í…ì¸  ì˜ì—­ -->
    <div id="tab-content" style="display:none;">
      <div id="tab-title"></div>
      <div id="tab-body"></div>
    </div>
  </div>

  <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ (ì „ì—­) -->
  <div id="loading-spinner" style="display:none;" role="status" aria-live="polite">
    <div class="spinner"></div>
    <p>ë¡œë”© ì¤‘...</p>
  </div>

  <!-- ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
  <div id="error-message" style="display:none;" role="alert" aria-live="assertive"></div>

  <!-- PWA ì„¤ì¹˜ ë°°ë„ˆ (ì„ íƒì‚¬í•­) -->
  <div id="pwa-install-banner" style="display:none;" class="pwa-banner">
    <div class="pwa-content">
      <span class="pwa-icon">ğŸ“±</span>
      <div class="pwa-text">
        <strong>ì•±ìœ¼ë¡œ ì„¤ì¹˜</strong>
        <p>í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ë” ì‰½ê²Œ ì‚¬ìš©í•˜ì„¸ìš”</p>
      </div>
      <button id="pwa-install-btn" class="pwa-install-btn">ì„¤ì¹˜</button>
      <button id="pwa-close-btn" class="pwa-close-btn">âœ•</button>
    </div>
  </div>

  <!-- ì˜¤í”„ë¼ì¸ ìƒíƒœ ì•Œë¦¼ -->
  <div id="offline-banner" style="display:none;" class="offline-banner">
    <span>ğŸ“¶ ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</span>
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© (ìµœì í™”ëœ ìˆœì„œ) -->
  <!-- 1. ê¸°ë³¸ ì„¤ì • ë° ìœ í‹¸ë¦¬í‹° -->
  <script type="module" src="scripts/firebase-config.js"></script>
  <script type="module" src="scripts/utils/date-utils.js"></script>
  <script type="module" src="scripts/utils/dom-utils.js"></script>

  <!-- 2. ë°ì´í„° ëª¨ë¸ -->
  <script type="module" src="scripts/parts-list.js"></script>

  <!-- 3. ì»´í¬ë„ŒíŠ¸ -->
  <script type="module" src="scripts/components/task-item.js"></script>
  <script type="module" src="scripts/templates/task-templates.js"></script>

  <!-- 4. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ -->
  <script type="module" src="scripts/task-save.js"></script>
  <script type="module" src="scripts/settle.js"></script>

  <!-- 5. UI ì»¨íŠ¸ë¡¤ëŸ¬ -->
  <script type="module" src="scripts/task-ui.js"></script>

  <!-- 6. ì¸ì¦ (ë§ˆì§€ë§‰) -->
  <script type="module" src="scripts/auth.js"></script>

  <!-- PWA ë° ëª¨ë°”ì¼ ê¸°ëŠ¥ -->
  <script>
    // PWA ì„¤ì¹˜ ì§€ì›
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // ì„¤ì¹˜ ë°°ë„ˆ í‘œì‹œ (ì„ íƒì )
      const banner = document.getElementById('pwa-install-banner');
      if (banner && localStorage.getItem('pwa-dismissed') !== 'true') {
        banner.style.display = 'block';
      }
    });

    // PWA ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­
    document.addEventListener('DOMContentLoaded', () => {
      const installBtn = document.getElementById('pwa-install-btn');
      const closeBtn = document.getElementById('pwa-close-btn');
      const banner = document.getElementById('pwa-install-banner');

      if (installBtn) {
        installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('PWA ì„¤ì¹˜ ê²°ê³¼:', outcome);
            deferredPrompt = null;
            if (banner) banner.style.display = 'none';
          }
        });
      }

      if (closeBtn && banner) {
        closeBtn.addEventListener('click', () => {
          banner.style.display = 'none';
          localStorage.setItem('pwa-dismissed', 'true');
        });
      }
    });

    // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
    function updateOnlineStatus() {
      const offlineBanner = document.getElementById('offline-banner');
      if (offlineBanner) {
        if (navigator.onLine) {
          offlineBanner.style.display = 'none';
        } else {
          offlineBanner.style.display = 'block';
        }
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // ì´ˆê¸° ìƒíƒœ í™•ì¸
    document.addEventListener('DOMContentLoaded', updateOnlineStatus);

    // ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™”
    document.addEventListener('DOMContentLoaded', () => {
      // iOS Safari 100vh ì´ìŠˆ í•´ê²°
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      
      setViewportHeight();
      window.addEventListener('resize', setViewportHeight);
      window.addEventListener('orientationchange', () => {
        setTimeout(setViewportHeight, 100);
      });

      // í„°ì¹˜ ìŠ¤í¬ë¡¤ ê°œì„  (iOS)
      document.body.style.webkitOverflowScrolling = 'touch';
      
      // íƒ­ í•˜ì´ë¼ì´íŠ¸ ì œê±° (Android)
      document.body.style.webkitTapHighlightColor = 'transparent';
      
      // ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ (í•„ìš”ì‹œ)
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (event) => {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      // í‚¤ë³´ë“œ ëŒ€ì‘ (ëª¨ë°”ì¼ì—ì„œ input focus ì‹œ ìŠ¤í¬ë¡¤ ì¡°ì •)
      const inputs = document.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        input.addEventListener('focus', () => {
          // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¬ ë•Œë¥¼ ëŒ€ë¹„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ìŠ¤í¬ë¡¤
          setTimeout(() => {
            input.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center' 
            });
          }, 300);
        });
      });

      // í’€ìŠ¤í¬ë¦° ê°ì§€ ë° ì¡°ì •
      document.addEventListener('fullscreenchange', setViewportHeight);
      document.addEventListener('webkitfullscreenchange', setViewportHeight);
      
      // ìƒíƒœë°” ë†’ì´ ê°ì§€ (iOS)
      if (window.navigator.standalone) {
        document.body.classList.add('standalone');
      }
    });

    // ì„±ëŠ¥ ìµœì í™”: ì´ë¯¸ì§€ ì§€ì—° ë¡œë”© (í•„ìš”ì‹œ)
    if ('IntersectionObserver' in window) {
      const lazyImages = document.querySelectorAll('img[data-src]');
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            imageObserver.unobserve(img);
          }
        });
      });

      lazyImages.forEach(img => imageObserver.observe(img));
    }

    // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW ë“±ë¡ ì„±ê³µ:', registration.scope);
          })
          .catch((registrationError) => {
            console.log('SW ë“±ë¡ ì‹¤íŒ¨:', registrationError);
          });
      });
    }

    // ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” ê°ì§€
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && window.auth?.currentUser) {
        // ì•±ì´ ë‹¤ì‹œ í™œì„±í™”ë  ë•Œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        console.log('ì•± ë‹¤ì‹œ í™œì„±í™” - ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
        
        // í˜„ì¬ í™”ë©´ì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        const activeTab = document.querySelector('.worker-tab-btn.active');
        if (activeTab) {
          if (activeTab.id === 'today-tab' && window.loadWorkerTodayTasks) {
            window.loadWorkerTodayTasks();
          } else if (activeTab.id === 'done-tab' && window.loadWorkerDoneTasks) {
            window.loadWorkerDoneTasks();
          }
        } else if (window.isCurrentUserAdmin && window.isCurrentUserAdmin()) {
          // ê´€ë¦¬ìëŠ” í˜„ì¬ í™œì„± íƒ­ì— ë”°ë¼ ìƒˆë¡œê³ ì¹¨
          if (window.loadTodayTasks) {
            // ê¸°ë³¸ì ìœ¼ë¡œ ì˜¤ëŠ˜ì‘ì—… ìƒˆë¡œê³ ì¹¨
            window.loadTodayTasks();
          }
        }
      }
    });

    // ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬
    window.addEventListener('error', (event) => {
      console.error('ì „ì—­ ì—ëŸ¬:', event.error);
      // ì‚¬ìš©ìì—ê²ŒëŠ” ê°„ë‹¨í•œ ë©”ì‹œì§€ë§Œ í‘œì‹œ
      if (window.showError) {
        window.showError('ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
      if (window.showError) {
        window.showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
      event.preventDefault();
    });
  </script>

  <!-- PWA ë° ëª¨ë°”ì¼ ì „ìš© ìŠ¤íƒ€ì¼ -->
  <style>
    /* PWA ì„¤ì¹˜ ë°°ë„ˆ */
    .pwa-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #8ecae6, #219ebc);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .pwa-banner[style*="block"] {
      transform: translateY(0);
    }

    .pwa-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .pwa-icon {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .pwa-text {
      flex: 1;
    }

    .pwa-text strong {
      font-size: 1.1rem;
      display: block;
      margin-bottom: 4px;
    }

    .pwa-text p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .pwa-install-btn {
      background: white;
      color: #219ebc;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .pwa-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
      opacity: 0.8;
      margin-left: 10px;
    }

    /* ì˜¤í”„ë¼ì¸ ë°°ë„ˆ */
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #dc3545;
      color: white;
      padding: 10px 20px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
      z-index: 1001;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* ìŠ¤íƒ ë“œì–¼ë¡  ëª¨ë“œ (PWA) ìŠ¤íƒ€ì¼ */
    .standalone {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* í‚¤ë³´ë“œ ëŒ€ì‘ */
    @media screen and (max-height: 500px) {
      .header-bar {
        padding: 10px 20px;
      }
      
      .box {
        padding: 15px;
      }
      
      .menu-button {
        padding: 20px 8px;
        font-size: 16px;
        min-height: 80px;
      }
    }

    /* ë‹¤í¬ëª¨ë“œ ì§€ì› (ì„ íƒì‚¬í•­) */
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }
      
      .box, .task-item, .header-bar {
        background: #2d2d2d;
        border-color: #404040;
      }
      
      input, textarea, select {
        background: #3a3a3a;
        color: #e0e0e0;
        border-color: #555;
      }
      
      input:focus, textarea:focus, select:focus {
        border-color: #8ecae6;
      }
    }

    /* ê³ í•´ìƒë„ ë””ìŠ¤í”Œë ˆì´ ëŒ€ì‘ */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .spinner {
        border-width: 2px;
      }
      
      .header-icon {
        font-size: 1.6rem;
      }
    }

    /* ì ‘ê·¼ì„±: ëª¨ì…˜ ê°ì†Œ ì„¤ì • */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .task-item:hover {
        transform: none;
      }
      
      button:hover {
        transform: none;
      }
    }

    /* ì¸ì‡„ ìµœì í™” */
    @media print {
      .pwa-banner, .offline-banner, #loading-spinner, #error-message,
      .home-btn, .logout-btn, .pwa-install-btn, .pwa-close-btn {
        display: none !important;
      }
      
      body {
        background: white !important;
        color: black !important;
        font-size: 12pt;
      }
      
      .header-bar {
        background: white !important;
        box-shadow: none;
        border-bottom: 2px solid #000;
      }
      
      .task-item {
        break-inside: avoid;
        border: 1px solid #000;
        margin-bottom: 10pt;
      }
    }

    /* CSS ì‚¬ìš©ì ì •ì˜ ì†ì„± */
    :root {
      --vh: 1vh;
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
    }
  </style>

</body>
</html>