<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>다담티비 - 고객 동의서</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: white;
      min-height: 100vh;
      padding: 0;
    }
    .container {
      background: white;
      padding: 20px;
      max-width: 100%;
      width: 100%;
      min-height: 100vh;
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
      font-weight: bold;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 18px;
    }
    .section {
      margin: 20px 0;
      padding: 0;
    }
    .section-header {
      margin-bottom: 15px;
    }
    .section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 20px;
      font-weight: bold;
    }
    .content-box {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 16px;
      color: #333;
      line-height: 1.8;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .content-box p {
      margin-bottom: 12px;
    }
    .content-box ul {
      margin: 0 0 12px 20px;
      padding: 0;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
      color: black;
      font-weight: bold;
      padding: 15px 0;
    }
    .checkbox-label input {
      margin-right: 10px;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    #signatureCanvas {
      width: 100%;
      height: 250px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: crosshair;
      margin-top: 10px;
    }
    .btn {
      padding: 18px 30px;
      border: none;
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s;
      font-weight: bold;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
    }
    .btn-secondary {
      background: #f44336;
      color: white;
    }
    .btn-secondary:hover {
      background: #d32f2f;
    }
    .error {
      color: #f44336;
      text-align: center;
      padding: 30px;
      font-size: 18px;
    }
    .success {
      color: #4caf50;
      text-align: center;
      padding: 30px;
      font-size: 20px;
    }
    .success h2 {
      font-size: 28px;
      margin-bottom: 15px;
    }
    .success p {
      font-size: 18px;
    }
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loadingDiv" class="loading">
      <p>로딩 중...</p>
    </div>
    
    <div id="errorDiv" class="error" style="display:none;"></div>
    
    <div id="agreementForm" style="display:none;">
      <h1>다담티비</h1>
      <p class="subtitle">TV 설치 서비스 고객 동의서</p>
      
      <div class="section">
        <div class="section-header">
          <h3>개인정보 수집 및 이용 동의</h3>
        </div>
        <div class="content-box">
          <p><strong>1. 수집 항목:</strong> 성명, 연락처, 주소</p>
          <p><strong>2. 수집 목적:</strong> TV 설치 서비스 제공, 일정 안내 및 고객 관리</p>
          <p><strong>3. 보유 기간:</strong> 서비스 완료 후 1년간 보관 후 파기(단, 관련 법령에 따라 보관이 필요한 경우는 예외)</p>
          <p><strong>4. 동의 거부 권리:</strong> 개인정보 수집·이용에 대한 동의를 거부할 수 있으나, 동의하지 않을 경우 서비스 제공이 제한될 수 있습니다.</p>
        </div>
        <label class="checkbox-label">
          <input type="checkbox" id="privacyAgree">
          동의합니다
        </label>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h3>TV 이전 설치 안내사항 및 책임 범위</h3>
        </div>
        <div class="content-box">
          <p style="font-weight:bold;">본인은 TV 이전 설치 서비스와 관련하여 아래 안내사항을 충분히 확인하고 이에 동의합니다.</p>
          
          <p style="font-weight:bold;">1. 제품 파손에 대한 책임</p>
          <p>이전 설치 작업 중 작업자의 과실로 인해 TV 패널 파손, 외관 파손 등 물리적인 파손이 발생한 경우에 한하여 회사에서 책임지고 보상합니다.</p>
          
          <p style="font-weight:bold;">2. 전자제품 특성에 따른 고장 발생 안내</p>
          <p>TV는 정밀 전자제품으로서 이전 설치 전·후를 불문하고 다음과 같은 고장 증세가 발생할 수 있음을 인지합니다.</p>
          <ul>
            <li>화면 미출력, 깜빡임, 줄 발생, 멍, 번짐</li>
            <li>색상 이상(변색, 색 왜곡 등)</li>
            <li>전원 불량 또는 갑작스러운 꺼짐</li>
            <li>소리 출력 불량 및 잡음</li>
            <li>채널 수신 불량</li>
            <li>외부기기 및 입력 신호 인식 오류</li>
            <li>리모컨 작동 불량</li>
            <li>네트워크 및 스마트 기능 이상</li>
            <li>기타 모든 전기·전자적 고장 증세</li>
          </ul>
          
          <p style="font-weight:bold;">3. 고장 증세에 대한 책임 범위</p>
          <p>위와 같은 모든 전기·전자적 고장 증세는 이전 설치 작업과의 인과관계와 관계없이 회사의 보상 또는 A/S 대상이 아니며, 제조사 A/S를 이용하는 것에 동의합니다.</p>
          
          <p style="font-weight:bold;">4. 출장비 발생 안내(고객 변심 및 설치 불가)</p>
          <p>작업자가 현장에 방문한 이후 고객의 단순 변심, 설치 위치 변경 요청, 현장 구조 또는 설치 환경 문제로 인해 설치가 진행되지 못한 경우에도 출장비가 발생할 수 있음에 동의합니다.</p>
          
          <p style="font-weight:bold;">5. 통신선 연장 및 통신 관련 안내</p>
          <p>TV 시청을 위한 통신선 연장, 인터넷·유선 방송 관련 작업은 회사의 작업 범위에 포함되지 않으며, 필요 시 고객이 이용 중인 통신사 또는 유선 방송사에 별도로 요청해야 함을 확인합니다.</p>
          
          <p style="font-weight:bold;">6. 설치 위치 및 추가 작업 안내</p>
          <p>설치 완료 후 TV 위치 변경, 재설치, 추가 배선 또는 별도 작업 요청 시 추가 비용이 발생할 수 있음을 확인합니다.</p>
        </div>
        <label class="checkbox-label">
          <input type="checkbox" id="noticeAgree">
          동의합니다
        </label>
      </div>
      
      <div class="section">
        <h3 style="margin-bottom:15px;">서명</h3>
        <canvas id="signatureCanvas"></canvas>
        <button onclick="clearSignature()" style="margin-top:10px;padding:8px 15px;background:#e0e0e0;color:#666;border:none;border-radius:4px;cursor:pointer;font-size:15px;">서명 다시하기</button>
      </div>
      
      <button class="btn btn-primary" onclick="submitAgreement()" style="margin-top:30px;font-size:20px;padding:18px;">동의 완료</button>
    </div>
    
    <div id="successDiv" class="success" style="display:none;">
      <h2>동의가 완료되었습니다!</h2>
      <p style="margin-top:20px;">감사합니다.</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCSrhEZtE44KT66sTke6g-ZH3732QjFNyA",
      authDomain: "dadam-work.firebaseapp.com",
      projectId: "dadam-work",
      storageBucket: "dadam-work.appspot.com",
      messagingSenderId: "617534061102",
      appId: "1:617534061102:web:b2dec870a45c6a5b20bdbf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentToken = null;
    let currentTaskId = null;
    let hasSignature = false;

    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = 250;
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;

    let isDrawing = false;

    // Placeholder 그리기 함수
    function drawPlaceholder() {
      ctx.save();
      ctx.fillStyle = '#ccc';
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('이름을 적어주세요', canvas.width / 2, canvas.height / 2);
      ctx.restore();
    }

    // 초기 placeholder 표시
    drawPlaceholder();

    canvas.addEventListener('mousedown', (e) => {
      if (!hasSignature) {
        // 첫 서명 시 placeholder 지우기
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('mousemove', (e) => {
      if (isDrawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        hasSignature = true;
      }
    });

    canvas.addEventListener('mouseup', () => {
      isDrawing = false;
    });

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (!hasSignature) {
        // 첫 서명 시 placeholder 지우기
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (isDrawing) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
        ctx.stroke();
        hasSignature = true;
      }
    });

    canvas.addEventListener('touchend', () => {
      isDrawing = false;
    });

    window.clearSignature = function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasSignature = false;
      // Placeholder 다시 그리기
      drawPlaceholder();
    };

    async function loadAgreement() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        showError('유효하지 않은 링크입니다.');
        return;
      }

      currentToken = token;

      try {
        const linkDoc = await getDoc(doc(db, 'agreementLinks', token));
        
        if (!linkDoc.exists()) {
          showError('유효하지 않은 링크입니다.');
          return;
        }

        const linkData = linkDoc.data();
        
        if (linkData.status === 'completed') {
          showError('이미 완료된 동의서입니다.');
          return;
        }

        const now = new Date();
        const expiresAt = linkData.expiresAt.toDate();
        if (now > expiresAt) {
          showError('만료된 링크입니다.');
          return;
        }

        currentTaskId = linkData.taskId;
        
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('agreementForm').style.display = 'block';

      } catch (error) {
        console.error('Error:', error);
        showError('오류가 발생했습니다: ' + error.message);
      }
    }

    window.submitAgreement = async function() {
      const privacyAgree = document.getElementById('privacyAgree').checked;
      const noticeAgree = document.getElementById('noticeAgree').checked;

      if (!privacyAgree || !noticeAgree) {
        alert('모든 항목에 동의해주세요.');
        return;
      }

      if (!hasSignature) {
        alert('서명을 해주세요.');
        return;
      }

      const agreementData = {
        method: 'sms',
        privacyAgreed: true,
        noticeAgreed: true,
        agreedAt: serverTimestamp(),
        agreementType: 'signature',
        signatureData: canvas.toDataURL()
      };

      try {
        await updateDoc(doc(db, 'tasks', currentTaskId), {
          agreementStatus: 'completed',
          customerAgreement: agreementData
        });

        await updateDoc(doc(db, 'agreementLinks', currentToken), {
          status: 'completed',
          completedAt: serverTimestamp()
        });

        document.getElementById('agreementForm').style.display = 'none';
        document.getElementById('successDiv').style.display = 'block';

      } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다: ' + error.message);
      }
    };

    function showError(message) {
      document.getElementById('loadingDiv').style.display = 'none';
      document.getElementById('errorDiv').textContent = message;
      document.getElementById('errorDiv').style.display = 'block';
    }

    loadAgreement();
  </script>
</body>
</html>
